<!DOCTYPE html>
<html lang="nl">
<head>
  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4062633211824348"
    crossorigin="anonymous"></script>

  <meta charset="UTF-8" />
  <title>Voetbal4All - Artikels & verhalen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://voetbal4all-backend-database.onrender.com" crossorigin>
  <link rel="dns-prefetch" href="https://voetbal4all-backend-database.onrender.com">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap">
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Ensure pagination button labels are visible on dark background */
    #pagination .btn-ghost-sm {
      color: #fff;
    }
    #pagination .btn-ghost-sm:disabled {
      color: rgba(255,255,255,0.6);
      opacity: 1; /* keep text readable even when disabled */
    }

    /* Force article thumbnails to be visible */
    #article-list img { display: block !important; visibility: visible !important; opacity: 1 !important; }
    .ad-card-header img { max-width: 100%; height: auto; }
  </style>
  </head>

<body class="v4-hide-live-mobile">
  <div class="page">

    <!-- NAVBAR -->
    <header class="navbar">
      <div class="shell">
        <div class="navbar-inner">

          <a href="index.html" class="brand brand--logo-only">
            <img
              src="assets/img/brand/logo-voetbal4all.svg"
              alt="Voetbal4All"
              class="brand-logo"
              loading="eager"
            />
          </a>

          <nav class="nav-links">
            <a href="index.html" class="nav-link">Home</a>
            <a href="artikels.html" class="nav-link nav-link--active">Artikels</a>

            <!-- SPORTIEVE EVENTS -->
            <div class="nav-item nav-item--dropdown">
              <button class="nav-link nav-link--dropdown">
                Sportieve events <span class="nav-link-caret">▾</span>
              </button>
              <div class="nav-dropdown">
                <a href="events.html" class="nav-dropdown-link">Alle sportieve events</a>
                <a href="events.html?type=Tornooi" class="nav-dropdown-link">Tornooien</a>
                <a href="events.html?type=Vriendschappelijk" class="nav-dropdown-link">Vriendschappelijke wedstrijden</a>
                <a href="stages.html" class="nav-dropdown-link">Stages</a>
                <a href="events.html?type=Voetbalkamp" class="nav-dropdown-link">Voetbalkampen</a>
              </div>
            </div>

            <!-- CLUB & FUN -->
            <div class="nav-item nav-item--dropdown">
              <button class="nav-link nav-link--dropdown">
                Club &amp; fun <span class="nav-link-caret">▾</span>
              </button>
              <div class="nav-dropdown">
                <a href="algemene-events.html" class="nav-dropdown-link">Alle club &amp; fun events</a>
                <a href="dinners.html" class="nav-dropdown-link">Dinners &amp; eetdagen</a>
                <a href="algemene-events.html?type=Spelavond" class="nav-dropdown-link">Spelavonden &amp; acties</a>
                <a href="algemene-events.html?type=Fuif" class="nav-dropdown-link">Fuif / afterparty</a>
                <a href="algemene-events.html?type=Sponsor" class="nav-dropdown-link">Sponsor &amp; netwerk</a>
              </div>
            </div>

            <!-- VACATURES & PROFIELEN -->
            <div class="nav-item nav-item--dropdown">
              <button type="button" class="nav-link nav-link--dropdown">
                Vacatures &amp; profielen <span class="nav-link-caret">▾</span>
              </button>
              <div class="nav-dropdown">
                <a href="clubvacatures.html" class="nav-dropdown-link">Clubvacatures</a>
                <a href="trainers.html" class="nav-dropdown-link">Trainers</a>
                <a href="spelers.html" class="nav-dropdown-link">Spelers</a>
              </div>
            </div>

            <!-- SPORTIEF -->
            <div class="nav-item nav-item--dropdown">
              <button type="button" class="nav-link nav-link--dropdown">
                Sportief <span class="nav-link-caret">▾</span>
              </button>
              <div class="nav-dropdown">
                <a href="sportief-spelers.html" class="nav-dropdown-link">Spelersstatistieken</a>
                <a href="sportief-teams.html" class="nav-dropdown-link">Teamstatistieken</a>
                <a href="sportief-resultaten.html" class="nav-dropdown-link">Resultaten</a>
                <a href="sportief-rangschikkingen.html" class="nav-dropdown-link">Rangschikkingen</a>
                <a href="sportief-teams-in-de-kijker.html" class="nav-dropdown-link">Team/Medewerker in de kijker</a>
                <a href="sportief-supportersclubs.html" class="nav-dropdown-link">Supportersclubs</a>
              </div>
            </div>

            <!-- VOETBAL4ALL -->
            <div class="nav-item nav-item--dropdown">
              <button type="button" class="nav-link nav-link--dropdown">
                Voetbal4All <span class="nav-link-caret">▾</span>
              </button>
              <div class="nav-dropdown">
                <a href="gebruiksvoorwaarden.html" class="nav-dropdown-link">Gebruiksvoorwaarden</a>
                <a href="privacyverklaring.html" class="nav-dropdown-link">Privacyverklaring</a>
                <a href="contact.html" class="nav-dropdown-link">Contact</a>
              </div>
            </div>
          </nav>

          <a href="adverteren.html" class="nav-cta">
            <span>Adverteer nu</span>
            <span>Sponsor &amp; Ads</span>
          </a>

          <button class="nav-burger" aria-label="Menu">☰</button>
        </div>
      </div>
    </header>

    <!-- LIVE BANNER -->
    <section class="live-banner-top">
      <div class="shell">
        <div class="live-banner">
          <div class="live-label"><span class="live-dot"></span>Live resultaten</div>
          <div class="live-text">
            <span class="live-text-main"></span>
            <div class="live-updated"></div>
          </div>
          <div class="live-socials" aria-label="Volg Voetbal4All">
            <div class="live-socials-label">Volg ons</div>
            <div class="live-socials-icons"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- HEADER AD -->
    <section class="section-main" style="padding-top:10px;padding-bottom:10px;">
      <div class="shell">
        <div class="ad-slot ad-slot-header sticky-ad-header">
          <ins class="adsbygoogle"
            style="display:block"
            data-ad-client="ca-pub-4062633211824348"
            data-ad-slot="3518144343"
            data-ad-format="auto"
            data-full-width-responsive="true"></ins>
        </div>
      </div>
    </section>

    <main>
      <section class="section-main">
        <div class="shell">

          <!-- INTRO -->
          <article class="card" style="margin-bottom:12px;">
            <div class="card-header">
              <div>
                <div class="card-caption">Artikels</div>
                <div class="card-title">Laatste voetbalnieuws &amp; verhalen (BE &amp; NL)</div>
              </div>
              <span class="pill-small" id="news-count">—</span>
            </div>
            <p class="note">
              Filter op land en categorie, en zoek op club/competitie. De feed komt uit de backend via <strong>/api/news</strong>.
            </p>
          </article>

          <div class="v4-layout-sidebar">

            <!-- LINKS -->
            <div class="v4-content">

              <!-- ZOEK + FILTERS -->
              <div class="search-bar search-bar--advanced" style="margin-bottom:12px;">
                <input type="text" id="article-search-text" class="search-input" placeholder="Zoek op titel, club, competitie..." />
                <div class="search-filters-row">
                  <select id="article-filter-country" class="search-select">
                    <option value="">Land (alles)</option>
                    <option value="BE">België</option>
                    <option value="NL">Nederland</option>
                  </select>

                  <select id="article-filter-category" class="search-select">
                    <option value="">Categorie (alles)</option>
                    <option value="Jupiler Pro League">Jupiler Pro League</option>
                    <option value="Challenger Pro League">Challenger Pro League</option>
                    <option value="Beker">Beker</option>
                    <option value="Amateur">Amateur</option>
                    <option value="Jeugd">Jeugd</option>
                    <option value="Internationaal">Internationaal</option>
                    <option value="Vrouwen">Vrouwen</option>
                    <option value="Transfers">Transfers</option>
                    <option value="Algemeen">Algemeen</option>
                  </select>
                </div>
                <div class="form-helper">
                  Tip: klik op “Lees artikel” om jouw Voetbal4All-artikelpagina te openen.
                </div>
              </div>

              <!-- TOP INFEED AD -->
              <section class="section-main" style="padding-top:0;padding-bottom:10px;">
                <div class="ad-infeed">
                  <ins class="adsbygoogle"
                    style="display:block"
                    data-ad-client="ca-pub-4062633211824348"
                    data-ad-slot="4831226012"
                    data-ad-format="auto"
                    data-full-width-responsive="true"></ins>
                </div>
              </section>

              <!-- OVERZICHT -->
              <section class="section-main" style="padding-top:0;">
                <div class="card">
                  <div class="card-header">
                    <div>
                      <div class="card-caption">Overzicht</div>
                      <div class="card-title">Laatste artikels &amp; verhalen</div>
                    </div>
                    <span class="pill-small" id="news-count-2">—</span>
                  </div>

                  <div id="article-list" class="ad-card-list ad-card-list--stack">
                    <!-- gevuld via backend -->
                  </div>

                  <!-- PAGINATIE -->
                  <div id="pagination" style="margin-top:12px;"></div>

                  <p id="news-status" class="note" style="margin-top:10px; display:none;"></p>
                </div>
              </section>

            </div>

            <!-- RECHTS -->
            <aside class="v4-sidebar">
              <div class="v4-sidebar-sticky">

                <article class="card">
                  <div class="card-header">
                    <div>
                      <div class="card-caption">Advertentie</div>
                      <div class="card-title">Sponsor / Partner</div>
                    </div>
                    <span class="pill-small">Premium</span>
                  </div>
                  <div class="ad-placeholder">
                    Vaste partnerzone naast artikels. Ideaal voor sponsors, lokale ondernemers en sportdiensten.
                    <br/>
                    <span class="ad-size">Aanrader: 300 × 250 of 300 × 600</span>
                  </div>
                </article>

                <div class="ad-vertical v4-ad-sticky" style="margin-top:12px;">
                  <ins class="adsbygoogle"
                    style="display:block"
                    data-ad-client="ca-pub-4062633211824348"
                    data-ad-slot="6032627042"
                    data-ad-format="auto"
                    data-full-width-responsive="true"></ins>
                </div>

              </div>
            </aside>

          </div>

        </div>
      </section>
    </main>

    <!-- FOOTER -->
    <footer class="footer" id="footer-contact">
      <div class="shell">
        <div class="footer-grid">
          <div class="footer-brand">
            <div>Voetbal4All · voor spelers, ouders, trainers en clubs.</div>
            <div class="footer-legal">
              &copy; <span id="year"></span> Voetbal4All. Alle rechten voorbehouden.
            </div>
            <div class="footer-social">
              <a href="https://www.facebook.com/voetbal4all" target="_blank" rel="noopener noreferrer" class="footer-social-link">Facebook</a>
              <a href="https://www.instagram.com/voetbal.4.all/" target="_blank" rel="noopener noreferrer" class="footer-social-link">Instagram</a>
              <a href="https://www.tiktok.com/@voetbal4all.eu" target="_blank" rel="noopener noreferrer" class="footer-social-link">TikTok</a>
            </div>
          </div>
          <div class="footer-ad">
            FOOTER ADVERTENTIE / PARTNERLOGO<br>
            <span class="ad-size">Footer-banner</span>
          </div>
        </div>
      </div>
    </footer>

  </div>

  <script src="assets/js/image-utils.js"></script>
  <script>
    // Footer year
    document.getElementById("year").textContent = new Date().getFullYear();

    // Backend endpoints
    const IMG_BASE = "https://voetbal4all-backend-database.onrender.com";
    const NEWS_URL_FAST = IMG_BASE + "/api/news?limit=20";  // fast first paint (first page)
    const NEWS_URL_FULL = IMG_BASE + "/api/news?limit=200"; // full dataset for filters/pagination

    const articleList = document.getElementById("article-list");
    const newsStatus = document.getElementById("news-status");
    const newsCountTop = document.getElementById("news-count");
    const newsCountTop2 = document.getElementById("news-count-2");
    const paginationEl = document.getElementById("pagination");

    const articleSearchText = document.getElementById("article-search-text");
    const articleFilterCountry = document.getElementById("article-filter-country");
    const articleFilterCategory = document.getElementById("article-filter-category");

    let allItems = [];
    let filteredItems = [];       // ✅ nieuw: huidige filterresultaat
    let currentPage = 1;          // ✅ nieuw
    const PAGE_SIZE = 20;         // ✅ sneller eerste paint

    // Client-side cache to render instantly on repeat visits (does not affect backend order)
    const NEWS_CACHE_KEY = "v4_news_cache_v1";
    const NEWS_CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutes
    let lastRenderKey = "";

    function readNewsCache(){
      try {
        const raw = localStorage.getItem(NEWS_CACHE_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!parsed || !Array.isArray(parsed.items) || !parsed.ts) return null;
        if ((Date.now() - parsed.ts) > NEWS_CACHE_TTL_MS) return null;
        return parsed.items;
      } catch (_) {
        return null;
      }
    }

    function writeNewsCache(items){
      try {
        localStorage.setItem(NEWS_CACHE_KEY, JSON.stringify({ ts: Date.now(), items }));
      } catch (_) {}
    }

    function itemsSignature(items){
      // stable signature based on first N ids + length
      const arr = (items || []).slice(0, 80).map(it => String(it?.id || "").trim()).filter(Boolean);
      return `${(items || []).length}|${arr.join(",")}`;
    }

    function safe(s){ return (s ?? "").toString(); }
    function norm(s){ return safe(s).toLowerCase().trim(); }

    function inferCountry(a){
      const raw = String(a?.country || "").trim().toUpperCase();

      if (raw === "BE" || raw.includes("BELG")) return "BE";
      if (raw === "NL" || raw.includes("NEDER")) return "NL";

      // alles wat niet BE/NL is: internationaal
      return "INT";
    }

    function detectCountry(a){
    // 1) AI / backend country is leidend als aanwezig
    const raw = safe(a?.country).toUpperCase().trim();
    if (raw === "BE" || raw === "NL") return raw;

    // 2) Fallback: soms zit het in geschreven vorm
    const raw2 = safe(a?.country).toLowerCase();
    if (raw2.includes("belg")) return "BE";
    if (raw2.includes("neder")) return "NL";

    // 3) Fallback: prefix in fileName (indien je dat ooit gebruikt)
    const fn = safe(a?.fileName).toLowerCase();
    if (fn.startsWith("be_")) return "BE";
    if (fn.startsWith("nl_")) return "NL";

    // 4) Anders: internationaal / onbekend
    return "INT";
  }

    function countryLabel(cc){
      if (cc === "BE") return "België";
      if (cc === "NL") return "Nederland";
      return "Internationaal";
    }

    // Flags: single source of truth (local assets)
    const FLAG_SRC = {
      BE: "/assets/img/sources/flag-be.svg",
      NL: "/assets/img/sources/flag-nl.svg",
      INT: "/assets/img/sources/flag-int.svg"
    };

    function flagHtml(cc){
      const c = String(cc || "INT").trim().toUpperCase();
      const src = FLAG_SRC[c] || FLAG_SRC.INT;
      const alt = (c === "BE") ? "België" : (c === "NL") ? "Nederland" : "Internationaal";

      return `
        <span class="v4a-flag" aria-hidden="true">
          <img
            class="v4a-flag__img"
            src="${src}"
            alt="${alt}"
            loading="lazy"
            decoding="async"
            width="18"
            height="12"
          />
        </span>
      `.trim();
    }

    function fmtDate(iso){
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return safe(iso);
      return d.toLocaleDateString("nl-BE", { year: "numeric", month: "short", day: "2-digit" });
    }

    function toImgUrl(imageVal){
      // Supports backend formats:
      // - string: "/images/articles/..." or full https url
      // - object: { publicPath: "/images/..." } or { url: "https://..." }
      if (!imageVal) return null;

      let p = "";
      if (typeof imageVal === "string") {
        p = imageVal;
      } else if (typeof imageVal === "object") {
        p = String(imageVal.publicPath || imageVal.url || imageVal.src || "");
      }

      p = safe(p).trim();
      if (!p) return null;

      // Guard against accidental "[object Object]" / garbage
      if (p === "[object Object]") return null;

      // Determine special cases
      const pl = p.toLowerCase();

      // Allow placeholder.svg (so we never end up with “no thumbnail” in the UI)
      const isPlaceholderSvg = pl.includes("/images/placeholder.svg") || pl.endsWith("/images/placeholder.svg");

      // Suppress accidental brand/logo assets as thumbnails
      const isBrandLogo = pl.includes("/images/brand/") && pl.includes("voetbal4all") && pl.endsWith(".svg");
      if (isBrandLogo) return null;

      // Keep placeholder.svg (with or without query params) as a valid image
      if (isPlaceholderSvg) {
        if (p.startsWith("http://") || p.startsWith("https://")) return p;
        if (p.startsWith("/")) return IMG_BASE + p;
        return IMG_BASE + "/" + p;
      }

      if (p.startsWith("http://") || p.startsWith("https://")) return p;
      if (p.startsWith("/")) return IMG_BASE + p;
      return IMG_BASE + "/" + p;
    }

    function dedupeById(items){
      const seen = new Set();
      const out = [];
      for (const it of (items || [])) {
        const key = String(it?.id || "").trim();
        if (!key) continue;
        if (seen.has(key)) continue;
        seen.add(key);
        out.push(it);
      }
      return out;
    }

    function scheduleAdsPush(times){
      const n = Math.max(0, Number(times || 0));
      if (!n) return;
      const push = () => {
        try {
          for (let i = 0; i < n; i++) {
            (adsbygoogle = window.adsbygoogle || []).push({});
          }
        } catch (e) {}
      };
      if ("requestIdleCallback" in window) {
        requestIdleCallback(push, { timeout: 2000 });
      } else {
        setTimeout(push, 300);
      }
    }

    function renderAdInfeed(slot){
      return `
        <div class="ad-infeed" style="margin: 10px 0; min-height: 120px;">
          <ins class="adsbygoogle"
            style="display:block"
            data-ad-client="ca-pub-4062633211824348"
            data-ad-slot="${slot}"
            data-ad-format="auto"
            data-full-width-responsive="true"></ins>
        </div>
      `;
    }

    function cleanTitle(t){
      let s = String(t || "").trim();

      // Verwijder veelvoorkomende bron-tags / afkortingen
      s = s.replace(/\bVP\b/g, "");              // VoetbalPrimeur
      s = s.replace(/\bVI\b/g, "");              // Voetbal International
      s = s.replace(/\bNOS\b/g, "");
      s = s.replace(/\bHLN\b/g, "");
      s = s.replace(/\bAD\b/g, "");

      // Verwijder bronpatronen zoals " - VoetbalPrimeur", "| VI", "(VP)"
      s = s.replace(/\s*[\-|–|—|·|\|]\s*(Voetbalprimeur|Voetbal International|VI\.nl|NOS|HLN|AD|De Telegraaf)\s*$/i, "");
      s = s.replace(/\(\s*(VP|VI|NOS|HLN|AD)\s*\)\s*$/i, "");

      // Opruimen dubbele spaties
      s = s.replace(/\s{2,}/g, " ").trim();

      return s;
    }

    function firstTwoSentences(text){
      const s = safe(text).replace(/\s+/g, " ").trim();
      if (!s) return "";
      const parts = s.split(/(?<=[.!?])\s+/); // split op einde zin
      return parts.slice(0, 2).join(" ").trim();
    }

    function isBadThumb(url){
      const u = safe(url).trim().toLowerCase();
      if (!u) return true;
      if (u === "[object object]") return true;
      if (u.includes("placeholder")) return true;
      if (u.includes("/images/brand/") && u.includes("voetbal4all") && u.endsWith(".svg")) return true;
      return false;
    }

      function renderCard(a, idx = 0){
        const title = cleanTitle(a.title);

        const slug = safe(a.slug).trim();
        const id = safe(a.id).trim();

        if (!slug && !id) {
          console.warn("[ARTIKELS] Missing slug/id for article, skipping link:", a);
          return;
        }

        const url = slug
          ? ("artikel.html?slug=" + encodeURIComponent(slug))
          : ("artikel.html?id=" + encodeURIComponent(id));

        const cc = inferCountry(a);
        const categoryRaw = safe(a.category || "");
        const category = categoryRaw && categoryRaw.toLowerCase() !== "algemeen" ? categoryRaw : "";
        const date = safe(a.publishedAt || a.date || a.createdAt || "");
        const snippet = safe(a.snippet || "");
        let snippetClean = snippet
          .replace(/\b(bron|source)\s*:\s*.*$/i, "")
          .replace(/\b[a-z0-9-]+\.(be|nl|com|net|org)\b/gi, "")
          .replace(/\s*[-—|]\s*[A-Za-zÀ-ÿ0-9 .]{2,40}\s*$/i, "")
          .replace(/\s{2,}/g, " ")
          .trim();

        snippetClean = firstTwoSentences(snippetClean); // ✅ max 2 zinnen

        // Backend is single source of truth for image URLs
        const imgSrc = (typeof a?.image === "string" && a.image.startsWith("http"))
          ? a.image
          : null;
        const safeTitleAttr = (a.title || "").replace(/"/g, "&quot;");

        const thumbHtml = imgSrc
          ? `
            <img
              src="${imgSrc}"
              alt="${safeTitleAttr}"
              loading="${idx < 6 ? "eager" : "lazy"}"
              decoding="async"
              fetchpriority="${idx < 2 ? "high" : "low"}"
              referrerpolicy="no-referrer"
              width="96"
              height="64"
              style="width:96px;height:64px;object-fit:cover;border-radius:10px;"
              onerror="this.onerror=null;this.style.display='none';"
            />
          `.trim()
          : `
            <div
              aria-hidden="true"
              style="width:96px;height:64px;border-radius:10px;background:rgba(255,255,255,0.06);"
            ></div>
          `.trim();

        return `
          <article class="ad-card">
            <div class="ad-card-header" style="display:flex; gap:12px; align-items:flex-start;">
            ${thumbHtml}
              <div style="min-width:0;flex:1;">
                <div class="ad-card-title">${title}</div>
                <div class="ad-card-meta">
                  ${flagHtml(cc)}
                  <span class="ad-card-meta__country">${countryLabel(cc)}</span>
                  ${category ? `<span class="ad-card-meta__sep">·</span><span class="ad-card-meta__cat">${category}</span>` : ""}
                  <span class="ad-card-meta__sep">·</span>
                  <span class="ad-card-meta__date">${fmtDate(date)}</span>
                </div>
              </div>
            </div>

            ${snippetClean ? `<p class="note" style="margin-top:10px;">${snippetClean}</p>` : ""}

            <div class="ad-card-actions" style="margin-top:10px;">
              <a class="btn-ghost-sm" href="${url}">Lees artikel</a>
            </div>
          </article>
        `;
      }
    

      function applyFilters(){
        const q = norm(articleSearchText.value);
        const cRaw = articleFilterCountry?.value || "";
        const catRaw = articleFilterCategory?.value || "";

      // normalize "all" variants to empty string (= no filter)
      const c = (cRaw === "all" || cRaw === "alles") ? "" : cRaw;
      const cat = (catRaw === "all" || catRaw === "alles") ? "" : catRaw;

      const filtered = allItems.filter(a => {
        const text = norm((a.title||"") + " " + (a.snippet||"") + " " + (a.category||"") + " " + (a.country||""));
        if (q && !text.includes(q)) return false;

        if (c) {
          const cc = detectCountry(a); // ✅ gebruikt AI-country eerst, dan fallback
          if (cc !== c) return false;
        }
        
        if (cat) {
          const ca = safe(a.category || "");
          if (ca !== cat) return false;
        }
        return true;
      });

      filteredItems = filtered; // ✅ bewaren voor paginatie
      const total = filteredItems.length;

      const countLabel = total ? (total + " artikels") : "0 artikels";
      newsCountTop.textContent = countLabel;
      newsCountTop2.textContent = countLabel;

      if (!total){
        newsStatus.style.display = "block";
        newsStatus.textContent = "Geen artikels gevonden met deze filters.";
        if (paginationEl) paginationEl.innerHTML = "";
        return;
      } else {
        newsStatus.style.display = "none";
      }

      // ✅ paginatie: clamp huidige pagina
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      if (currentPage > totalPages) currentPage = totalPages;
      if (currentPage < 1) currentPage = 1;

      const start = (currentPage - 1) * PAGE_SIZE;
      const pageItems = filteredItems.slice(start, start + PAGE_SIZE);

      // Skip work if the visible state did not change
      const renderKey = [
        "p=" + currentPage,
        "q=" + norm(articleSearchText.value),
        "c=" + (articleFilterCountry?.value || ""),
        "cat=" + (articleFilterCategory?.value || ""),
        "ids=" + pageItems.map(it => String(it?.id || "")).join("|")
      ].join("::");
      if (renderKey === lastRenderKey) {
        // still ensure counts/pagination stay consistent
        return;
      }
      lastRenderKey = renderKey;

      articleList.innerHTML = "";
      const htmlParts = [];
      const adQueue = [];
      pageItems.forEach((a, i) => {
        htmlParts.push(renderCard(a, i));

        // In-feed ads (per pagina)
        if (i === 5) {
          htmlParts.push(renderAdInfeed("5761272101"));
          adQueue.push(true);
        }
        if (i === 13) {
          htmlParts.push(renderAdInfeed("4831226012"));
          adQueue.push(true);
        }
      });

      // Single DOM write (much faster, less layout thrash)
      articleList.innerHTML = htmlParts.join("");

      // Defer AdSense fill to idle time (prevents blocking the initial render)
      const pushAds = () => {
        if (!adQueue.length) return;
        try {
          for (let i = 0; i < adQueue.length; i++) {
            (adsbygoogle = window.adsbygoogle || []).push({});
          }
        } catch (e) {}
      };
      if ("requestIdleCallback" in window) {
        requestIdleCallback(pushAds, { timeout: 1500 });
      } else {
        setTimeout(pushAds, 200);
      }

      // ✅ paginatie UI onderaan (buiten #article-list zodat ads/cards het niet kunnen overlappen)
      if (paginationEl) {
        paginationEl.innerHTML = `
          <div class="card">
            <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
              <button class="btn-ghost-sm" id="pg-prev" ${currentPage === 1 ? "disabled" : ""}>Vorige</button>
              <div class="note" style="margin:0;">Pagina <strong>${currentPage}</strong> / ${totalPages}</div>
              <button class="btn-ghost-sm" id="pg-next" ${currentPage === totalPages ? "disabled" : ""}>Volgende</button>
            </div>
          </div>
        `;

        const btnPrev = document.getElementById("pg-prev");
        const btnNext = document.getElementById("pg-next");

        if (btnPrev) {
          btnPrev.onclick = () => {
            currentPage = Math.max(1, currentPage - 1);
            applyFilters();
            window.scrollTo({ top: 0, behavior: "smooth" });
          };
        }

        if (btnNext) {
          btnNext.onclick = () => {
            currentPage = Math.min(totalPages, currentPage + 1);
            applyFilters();
            window.scrollTo({ top: 0, behavior: "smooth" });
          };
        }
      }
          }
    async function fetchJsonWithTimeout(url, ms){
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), ms);
      try {
        const res = await fetch(url, { signal: controller.signal });
        if (!res.ok) throw new Error("HTTP " + res.status);
        return await res.json();
      } finally {
        clearTimeout(t);
      }
    }

    async function loadNews(){
      // 1) Try instant render from cache
      const cached = readNewsCache();
      if (cached && cached.length) {
        allItems = dedupeById(cached);
        // show immediately
        applyFilters();
      } else {
        // show loading state + quick skeleton to avoid "blank page" perception
        newsStatus.style.display = "block";
        newsStatus.textContent = "Artikels laden…";
        const skel = Array.from({ length: 8 }).map(() => `
          <article class="ad-card" aria-hidden="true">
            <div class="ad-card-header" style="display:flex; gap:12px; align-items:flex-start;">
              <div style="width:96px;height:64px;border-radius:10px;background:rgba(255,255,255,0.06);"></div>
              <div style="min-width:0;flex:1;">
                <div style="height:14px;width:70%;border-radius:6px;background:rgba(255,255,255,0.06);margin:4px 0;"></div>
                <div style="height:12px;width:45%;border-radius:6px;background:rgba(255,255,255,0.06);margin:8px 0;"></div>
              </div>
            </div>
          </article>
        `).join("");
        articleList.innerHTML = skel;
      }

      // 2) Refresh in background (network)
      try{
        // FAST: allow caching (browser/CDN) and time out quickly to avoid 10–15s hangs
        const data = await fetchJsonWithTimeout(NEWS_URL_FAST, 4500);
        const fresh = dedupeById(Array.isArray(data) ? data : (Array.isArray(data?.items) ? data.items : []));

        // Fast paint: if we had no cache, render ASAP with the first page results
        if (!cached || !cached.length) {
          allItems = fresh;
          lastRenderKey = "";
          applyFilters();
          newsStatus.style.display = "none";
          // push the 3 static ad slots (header, top infeed, sidebar) after first paint
          scheduleAdsPush(3);
        }

        // FULL: fetch in background with a longer timeout
        const dataFull = await fetchJsonWithTimeout(NEWS_URL_FULL, 12000);
        const fullItems = dedupeById(Array.isArray(dataFull) ? dataFull : (Array.isArray(dataFull?.items) ? dataFull.items : []));

        // Only re-render if data actually changed
        const prevSig = itemsSignature(allItems);
        const nextSig = itemsSignature(fullItems);

        writeNewsCache(fullItems);

        if (nextSig !== prevSig) {
          allItems = fullItems;
          lastRenderKey = ""; // force a single re-render
          applyFilters();
        }

        scheduleAdsPush(3); // ensure static slots fill even if cache was used
        newsStatus.style.display = "none";
      } catch (e) {
        // If cache already rendered, keep it and just show a subtle warning
        if (allItems && allItems.length) {
          newsStatus.style.display = "block";
          newsStatus.textContent = "Artikels geladen uit cache. Vernieuwen lukt momenteel niet.";
          return;
        }
        articleList.innerHTML = "";
        newsCountTop.textContent = "—";
        newsCountTop2.textContent = "—";
        newsStatus.style.display = "block";
        newsStatus.textContent = "Kon artikels niet laden. Controleer /api/news en CORS.";
      }
    }

    articleSearchText.addEventListener("input", () => { currentPage = 1; applyFilters(); });
    articleFilterCountry.addEventListener("change", () => { currentPage = 1; applyFilters(); });
    articleFilterCategory.addEventListener("change", () => { currentPage = 1; applyFilters(); });

    loadNews();
  </script>

  <script src="assets/js/nav-mobile.js"></script>
  <script src="assets/js/live-banner.js"></script>
</body>
</html>